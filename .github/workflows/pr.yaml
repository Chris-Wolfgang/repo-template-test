# This workflow runs all branches when a pull request is created. 
# If security settings have been properly configured, any branch that fails this workflow will be blocked from being merged into main and possibly other common branches link develop depending your specific settings

name: PR Checks

on:
  pull_request:
    branches:
      # List any other branches here that you want this workflow to run on
      - main

jobs:
  build-and-test:
    # Specifies the OS to run this workflow on. You can specify more than one. For a complete and current list, review the [documentation] (https://docs.github.com/en/actions/how-tos/write-workflows/choose-where-workflows-run/choose-the-runner-for-a-job)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          # Specifies the version of dotnet to use. You can specify multiple versions. For a complate list of supported versions review the [documentation](https://github.com/actions/setup-dotnet#inputs)
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        # Specify any additional build options
        run: dotnet build --no-restore --configuration Release

      # This is required to parse the XML files below
      - name: Install xmllint
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      # Ensure all tests pass and the code coverage is 80%+
      - name: Test with coverage and enforce minimum
        run: dotnet test --no-build --configuration Release   --collect:"XPlat Code Coverage"  /p:CollectCoverage=true  /p:CoverletOutputFormat=cobertura  /p:Threshold=80  /p:ThresholdType=line  /p:ThresholdStat=total

      # If coverlet package is not installed in the project no output will be generated above and the above will pass
      # code coverage (assuming tests pass). This verifies the coverage file was generated and thus coverlet is installed
      # and fails if it does not
      - name: Ensure code coverage is reported and >0 lines are valid
        run: |
          FILE=$(find . -name 'coverage.cobertura.xml' | head -n 1)
          if [ ! -f "$FILE" ]; then
            echo "❌ No coverage report found! Make sure coverlet.collector is installed and enabled."
            exit 1
          fi
          LINES_VALID=$(xmllint --xpath "string(/coverage/@lines-valid)" "$FILE")
          if [ "$LINES_VALID" = "0" ]; then
            echo "❌ No valid lines for code coverage found! Your tests may not be exercising any code or no code is instrumented."
            exit 1
          fi
